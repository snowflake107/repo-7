<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-0.52 plugin-docs plugin-id-default docs-doc-id-build/building-apps/security-part-1">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">The Cosmos Security Handbook: Part 1 - Core Chain | Explore the SDK</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.cosmos.network/img/banner.jpg"><meta data-rh="true" name="twitter:image" content="https://docs.cosmos.network/img/banner.jpg"><meta data-rh="true" property="og:url" content="https://docs.cosmos.network/v0.52/build/building-apps/security-part-1"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="0.52"><meta data-rh="true" name="docusaurus_tag" content="docs-default-0.52"><meta data-rh="true" name="docsearch:version" content="0.52"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-0.52"><meta data-rh="true" property="og:title" content="The Cosmos Security Handbook: Part 1 - Core Chain | Explore the SDK"><meta data-rh="true" name="description" content="Thank you to Roman Akhtariev and Alpin Yukseloglu for authoring this post. The original post can be found here."><meta data-rh="true" property="og:description" content="Thank you to Roman Akhtariev and Alpin Yukseloglu for authoring this post. The original post can be found here."><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://docs.cosmos.network/v0.52/build/building-apps/security-part-1"><link data-rh="true" rel="alternate" href="https://docs.cosmos.network/v0.52/build/building-apps/security-part-1" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.cosmos.network/v0.52/build/building-apps/security-part-1" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://QLS2QSP47E-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Explore the SDK" href="/opensearch.xml">


<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51029217-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>



<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="752cab42-f5d6-4af3-9d31-fb0d6e501c4a" data-project-name="Cosmos SDK" data-project-color="#5064FB" data-modal-disclaimer="This is a custom LLM for Interchain with access to Cosmos SDK developer documentation and resources. Please note that answers are generated by an AI so please use your best judgement before implementing." data-modal-image="img/logo-sdk.svg" data-project-logo="img/logo-sdk-white.svg" data-user-analytics-fingerprint-enabled="true" async></script><link rel="stylesheet" href="/assets/css/styles.0425b9d4.css">
<link rel="preload" href="/assets/js/runtime~main.ae6eca12.js" as="script">
<link rel="preload" href="/assets/js/main.5e40e4cd.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/logo-sdk.svg" alt="Cosmos SDK Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-sdk.svg" alt="Cosmos SDK Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Cosmos SDK</b></a><a class="navbar__item navbar__link" href="/v0.52/learn">Learn</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/v0.52/build/building-modules/intro">Build</a><a class="navbar__item navbar__link" href="/v0.52/user">User Guides</a><a class="navbar__item navbar__link" href="/v0.52/tutorials/vote-extensions/auction-frontrunning/getting-started">Tutorials</a><a class="navbar__item navbar__link" href="/api">REST API</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cosmos/cosmos-sdk" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="github-icon">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 0.300049C5.4 0.300049 0 5.70005 0 12.3001C0 17.6001 3.4 22.1001 8.2 23.7001C8.8 23.8001 9 23.4001 9 23.1001C9 22.8001 9 22.1001 9 21.1001C5.7 21.8001 5 19.5001 5 19.5001C4.5 18.1001 3.7 17.7001 3.7 17.7001C2.5 17.0001 3.7 17.0001 3.7 17.0001C4.9 17.1001 5.5 18.2001 5.5 18.2001C6.6 20.0001 8.3 19.5001 9 19.2001C9.1 18.4001 9.4 17.9001 9.8 17.6001C7.1 17.3001 4.3 16.3001 4.3 11.7001C4.3 10.4001 4.8 9.30005 5.5 8.50005C5.5 8.10005 5 6.90005 5.7 5.30005C5.7 5.30005 6.7 5.00005 9 6.50005C10 6.20005 11 6.10005 12 6.10005C13 6.10005 14 6.20005 15 6.50005C17.3 4.90005 18.3 5.30005 18.3 5.30005C19 7.00005 18.5 8.20005 18.4 8.50005C19.2 9.30005 19.6 10.4001 19.6 11.7001C19.6 16.3001 16.8 17.3001 14.1 17.6001C14.5 18.0001 14.9 18.7001 14.9 19.8001C14.9 21.4001 14.9 22.7001 14.9 23.1001C14.9 23.4001 15.1 23.8001 15.7 23.7001C20.5 22.1001 23.9 17.6001 23.9 12.3001C24 5.70005 18.6 0.300049 12 0.300049Z" fill="currentColor"/>
            </svg>
            </a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/v0.52/learn">v0.52</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/main/build/building-apps/security-part-1">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/v0.52/build/building-apps/security-part-1">v0.52</a></li><li><a class="dropdown__link" href="/v0.50/learn">v0.50</a></li><li><a class="dropdown__link" href="/v0.47/learn">v0.47</a></li><li><a href="https://docs.cosmos.network/v0.46/" target="_self" rel="noopener noreferrer" class="dropdown__link">v0.46<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://docs.cosmos.network/v0.45/" target="_self" rel="noopener noreferrer" class="dropdown__link">v0.45<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v0.52/build">Build</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/v0.52/build/building-apps/app-go">Building Apps</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.52/build/building-apps/app-go">Overview of app.go</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.52/build/building-apps/app-go-v2">Overview of app_di.go</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.52/build/building-apps/app-mempool">Application Mempool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.52/build/building-apps/app-upgrade">Application Upgrade</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.52/build/building-apps/app-testnet">Application Testnets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.52/build/building-apps/app-go-genesis">app-go-genesis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.52/build/building-apps/system-tests">System Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/v0.52/build/building-apps/security-part-1">The Cosmos Security Handbook: Part 1 - Core Chain</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/building-modules/intro">Building Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/abci/introduction">ABCI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/modules">Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/migrations/intro">Migrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/packages">Packages</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/tooling">Tooling</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/architecture">ADRs</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/rfc">RFC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.52/build/spec">Specifications</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Building Apps</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">The Cosmos Security Handbook: Part 1 - Core Chain</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v0.52</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>The Cosmos Security Handbook: Part 1 - Core Chain</h1><blockquote><p>Thank you to <strong><a href="https://twitter.com/akhtariev" target="_blank" rel="noopener noreferrer">Roman Akhtariev</a> and <a href="https://twitter.com/0xalpo" target="_blank" rel="noopener noreferrer">Alpin Yukseloglu</a></strong> for authoring this post. The original post can be found <a href="https://www.faulttolerant.xyz/2024-01-16-cosmos-security-1/" target="_blank" rel="noopener noreferrer">here</a>.</p></blockquote><blockquote><p><a href="https://www.trailofbits.com/" target="_blank" rel="noopener noreferrer">Trail of bits</a> hosts another set of guidelines <a href="https://github.com/crytic/building-secure-contracts/tree/master/not-so-smart-contracts/cosmos" target="_blank" rel="noopener noreferrer">here</a></p></blockquote><p>The defining property of the Cosmos stack is that it is unconstrained. The layers of the stack are porous, and, to a sufficiently motivated developer, nothing is off-limits. From a security standpoint, this freedom can be terrifying.</p><p>In this post, we aim to shed some light on the security landscape for the Cosmos stack.  We will emphasize areas that are particularly unintuitive, either because they are unique to Cosmos or because they are areas that developers who have not built appchains before are unlikely to have encountered.</p><p>Since the surface of new risks that come with developing appchains is vast, we cannot possibly fit everything into a single post. Thus, this article will be focused only on the security surface of the core chain. We are reserving CosmWasm and IBC-related risks for a future post.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><p>Application logic in Cosmos-based appchains can affect all parts of the stack. This level of expressivity necessitates important guardrails to be removed, which introduces certain risks that would otherwise be protected against. To a developer who is accustomed to building on general-purpose chains, the protections in place are often invisible to the point of going unnoticed. Thus, when faced with ultimate control, it can be difficult to differentiate between what is a new tool and what is an unmarked danger zone.</p><p>In the sections that follow, we break down the common ways developers can shoot themselves in the foot when building appchains. Some of these risks are more severe than others, but almost all are relatively unique to building appchains with the Cosmos SDK.</p><p>Specifically, we will cover the following areas with multiple concrete examples for each:</p><ul><li>Non-determinism</li><li>In-protocol panics</li><li>Unmetered/unbounded computation</li><li>Prefix iteration &amp; key malleability</li><li>Fee market &amp; gas Issues</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="non-determinism">Non-Determinism<a href="#non-determinism" class="hash-link" aria-label="Direct link to Non-Determinism" title="Direct link to Non-Determinism">​</a></h2><p>One of the consequences of opening up the consensus layer to app developers is that the code they write must not break critical properties required to reach consensus. Determinism is one such property that is particularly easy to compromise.</p><p>At a high level, determinism means that for the same input, all nodes in the network always produce the same output. It is an inherent requirement of blockchains. Without it, it is unclear what the nodes in the network are trying to agree on.</p><p>Simply put, non-determinism in the executed code can trigger the chain to fork or for honest validators to be unfairly slashed.</p><blockquote><p>As a brief side-note: while non-determinism should generally be avoided, we have provided a list in the appendix covering exactly which parts of the Cosmos SDK where the code needs to be deterministic. In general, anything that touches the state machine must be.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="randomness">Randomness<a href="#randomness" class="hash-link" aria-label="Direct link to Randomness" title="Direct link to Randomness">​</a></h3><p>Trivially, any use of randomness should be prohibited in the state machine. Keep an eye on the use of the Go <code>rand</code> package. It should not be used within the state-machine scope, including the imported dependencies.</p><p>In general, if randomness is used, it should be accessed in a deterministic way (much like <a href="https://chain.link/vrf" target="_blank" rel="noopener noreferrer">Chainlink&#x27;s VRF</a>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="go-map-internals">Go map internals<a href="#go-map-internals" class="hash-link" aria-label="Direct link to Go map internals" title="Direct link to Go map internals">​</a></h3><p>Under the hood, Go maps are implemented as a hash map of buckets where each bucket contains up to 8 key-value pairs. Since some key-value pairs within the bucket can be empty, Go uses randomness to select the starting element within the bucket. See <a href="https://medium.com/i0exception/map-iteration-in-go-275abb76f721" target="_blank" rel="noopener noreferrer">this article</a> for the breakdown.</p><p><strong>When building on the Cosmos SDK, you should never iterate over a Go map</strong>. Doing so results in non-determinism. Instead, if <code>map</code> usage is inevitable, it is necessary to convert it to a <code>slice</code> and sort it. See an example <a href="https://github.com/osmosis-labs/osmosis/blob/b0aee0006ce55d0851773084bd7880db7e32ad70/osmoutils/partialord/internal/dag/dag.go#L290-L302" target="_blank" rel="noopener noreferrer">here</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="invalid-time-handling">Invalid Time Handling<a href="#invalid-time-handling" class="hash-link" aria-label="Direct link to Invalid Time Handling" title="Direct link to Invalid Time Handling">​</a></h3><p>Avoid using <code>time.Now()</code> since nodes are unlikely to process messages at the same point in time even if they are in the same timezone. Instead, always rely on <code>ctx.BlockTime()</code> which should be the canonical definition of what &quot;now&quot; is.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-calls">API calls<a href="#api-calls" class="hash-link" aria-label="Direct link to API calls" title="Direct link to API calls">​</a></h3><p>Network requests are generally non-deterministic. As a result, they should be avoided in the state machine.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="concurrency-and-multithreading">Concurrency And Multithreading<a href="#concurrency-and-multithreading" class="hash-link" aria-label="Direct link to Concurrency And Multithreading" title="Direct link to Concurrency And Multithreading">​</a></h3><p>Thread or goroutine pre-emption is likely to lack determinism. As a result, one should generally avoid using goroutines to be used anywhere within the state-machine scope. There are, of course, exceptions where we may process data concurrently for aggregation/counting which would be deterministic. However, such use cases are rare enough to consider the general use of goroutines in the app chain code as a red flag.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cross-platform-floats">Cross-Platform Floats<a href="#cross-platform-floats" class="hash-link" aria-label="Direct link to Cross-Platform Floats" title="Direct link to Cross-Platform Floats">​</a></h3><p>For reasons that could easily take up a <a href="https://randomascii.wordpress.com/2013/07/16/floating-point-determinism/" target="_blank" rel="noopener noreferrer">separate article</a>, it is safe to claim that float arithmetic is non-deterministic across platforms. Therefore, they must never be used in the app chain state-machine scope.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="in-protocol-panics">In-Protocol Panics<a href="#in-protocol-panics" class="hash-link" aria-label="Direct link to In-Protocol Panics" title="Direct link to In-Protocol Panics">​</a></h2><p>One of the most unintuitive differences between developing a general-purpose chain and building one&#x27;s own appchain is that code can be run in-protocol without being triggered by a specific transaction.</p><p>While this feature unlocks an incredible amount of expressivity for developers (such as custom precompiles and in-protocol arbitrage/liquidations), it also exposes various ways for the chain to be halted. One of the common ways this happens is through panics.</p><p>There are of course times when panics are appropriate to use instead of errors, but it is important to keep in mind that <strong>panics in module-executed code (<code>Begin/EndBlock</code>) will cause the chain to halt</strong>.</p><p>While these halts are generally not difficult to recover when isolated, they still pose a valid attack vector, especially if the panics can be triggered repeatedly. They also result in expensive social coordination and reputation costs stemming from downtime.</p><p>Thus, <strong>we should be cognizant of when we use panics and ensure that we avoid them with behavior that could be handled well with an error.</strong> Of course, it is still okay to guardrail unexpected flows with panics when needed, especially if the behavior is such that a chain halt <em>would</em> be appropriate.</p><p>Cosmos SDK takes care of catching and recovering from panics in all of <code>PrepareProposal</code> , <code>ProcessProposal</code>, <code>DeliverTx</code> , leaving only <code>Begin/EndBlock</code> for this class of vulnerabilities.</p><p>For reference, the Osmosis codebase catches and silently logs most panics stemming from <code>Begin/EndBlock</code> with <a href="https://github.com/osmosis-labs/osmosis/blob/b0aee0006ce55d0851773084bd7880db7e32ad70/osmoutils/cache_ctx.go#L13-L44" target="_blank" rel="noopener noreferrer">this</a> helper. In almost all cases, it is most productive to understand the reason behind panic and reconcile it without halting the chain entirely.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="math-overflow">Math Overflow<a href="#math-overflow" class="hash-link" aria-label="Direct link to Math Overflow" title="Direct link to Math Overflow">​</a></h3><p>By default, all SDK math operations panic on overflows. This means that any math that is done in functions that get called in <code>Begin/EndBlock</code> should make sure to catch overflow panics using a helper similar to the one linked above.</p><p>For example, let&#x27;s say a chain adds a feature that involves checking the spot price of arbitrary assets in <code>BeginBlock</code>. If the overflow panic is not caught, an attacker could create a market for a new asset and manipulate the price such that the spot price calculation overflows, triggering a panic at the top of each block. Since this is an easily repeatable attack, the attacker could presumably halt the chain in perpetuity until a hard fork patches the issue by catching overflow panics.</p><p><strong>The solution to this problem is to catch panics whenever there is SDK math run in <code>Begin/EndBlock</code>.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bulk-coin-sends">Bulk Coin Sends<a href="#bulk-coin-sends" class="hash-link" aria-label="Direct link to Bulk Coin Sends" title="Direct link to Bulk Coin Sends">​</a></h3><p>If a chain supports custom token transfer logic (e.g. blacklists for USDC), it needs to make sure all token transfers in <code>Begin/EndBlock</code> properly catch panics. While this is generally quite straightforward to do, it is commonly missed in one context: bulk coin sends.</p><p>Specifically, the Cosmos SDK allows for multiple coins to be transferred in one function call through its <code>[SendCoins](https://github.com/cosmos/cosmos-sdk/blob/d55985637e1484309b09e76d29f04f2c7258c3de/x/bank/keeper/send.go#L202)</code> function. This is a black-box function that does not allow for individual validation of each token transfer, which often leads to it being overlooked. A single panic trigger in a call to <code>SendCoins</code> in <code>Begin/EndBlock</code> can trigger a chain halt.</p><p>While one can catch the panic on the entire <code>SendCoins</code> call, this would mean that an attacker can DoS all transfers in the batch. Thus, <strong>the solution for these situations is to transfer coins one by one with <code>SendCoin</code> and verify each transfer so that problematic ones can be skipped.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unmetered-computation">Unmetered Computation<a href="#unmetered-computation" class="hash-link" aria-label="Direct link to Unmetered Computation" title="Direct link to Unmetered Computation">​</a></h2><p>In the standard Cosmos stack, only stateful operations are gas-metered. This implies that out-of-block compute that is not triggered by messages has no notion of a gas limit. Thus, any form of unbounded execution in such a context can be used to halt the chain.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="unmetered-execution-in-hooks">Unmetered Execution in Hooks<a href="#unmetered-execution-in-hooks" class="hash-link" aria-label="Direct link to Unmetered Execution in Hooks" title="Direct link to Unmetered Execution in Hooks">​</a></h3><p>Whenever one implements functionality involving hooks to arbitrary CosmWasm contracts, it is crucial to check whether this logic can be triggered by module-executed code. If it is, then an attacker can simply upload a contract that runs an infinite loop to halt the chain.</p><p>For instance, if a chain allows for arbitrary token transfer hooks and triggers them in <code>Begin/EndBlock</code>, then an attacker can create a token that executes an infinitely looping CosmWasm contract. Once this token is transferred in the next block&#x27;s <code>BeginBlock</code>, the chain will halt.</p><p><strong>The solution to this problem is to <a href="https://github.com/osmosis-labs/osmosis/blob/2a64b0b6171478b81b017a001f5179b199a38628/x/tokenfactory/keeper/before_send.go#L121-L128" target="_blank" rel="noopener noreferrer">wrap risky function calls</a> in a separate Context that has a gas limit.</strong> This assigns a gas budget to such calls that prevent them from running unboundedly and halting the chain.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="poorly-chosen-looprecursion-exit-condition">Poorly Chosen Loop/Recursion Exit Condition<a href="#poorly-chosen-looprecursion-exit-condition" class="hash-link" aria-label="Direct link to Poorly Chosen Loop/Recursion Exit Condition" title="Direct link to Poorly Chosen Loop/Recursion Exit Condition">​</a></h3><p>This is a consideration that seems trivial but comes up much more frequently than one might expect. If a loop in unmetered code is never exited or a recursion base case is never hit, it might lead to an expensive chain halt.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="slow-convergence-in-math-operations">Slow Convergence in Math Operations<a href="#slow-convergence-in-math-operations" class="hash-link" aria-label="Direct link to Slow Convergence in Math Operations" title="Direct link to Slow Convergence in Math Operations">​</a></h3><p>A few months ago, a security researcher <a href="https://blog.trailofbits.com/2023/10/23/numbers-turned-weapons-dos-in-osmosis-math-library/" target="_blank" rel="noopener noreferrer">reported a vulnerability</a> in the Osmosis codebase stemming from <a href="https://github.com/osmosis-labs/osmosis/blob/44a6a100a92f2984a760b41b7486fb9000ac670e/osmomath/math.go#L86" target="_blank" rel="noopener noreferrer">PowApprox function</a>. The crux of the issue was centered around long-lasting convergence for certain input values. A determined attacker could in theory use such edge cases to temporarily halt the chain. <strong>The solution in these cases is simple - <a href="https://github.com/osmosis-labs/osmosis/pull/6627" target="_blank" rel="noopener noreferrer">introduce a constant loop bound</a>.</strong></p><p>As a side note, from our experience, rational approximation is a more accurate and performant substitute to Taylor expansion which is used in <code>PowApprox</code> of the above example. See <a href="https://xn--2-umb.com/22/approximation/" target="_blank" rel="noopener noreferrer">this article</a> for details.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-malleability-and-prefix-iteration">Key Malleability and Prefix Iteration<a href="#key-malleability-and-prefix-iteration" class="hash-link" aria-label="Direct link to Key Malleability and Prefix Iteration" title="Direct link to Key Malleability and Prefix Iteration">​</a></h2><p>When onboarding onto the Cosmos stack, developers must familiarize themselves with its <a href="https://docs.cosmos.network/v0.46/core/store.html" target="_blank" rel="noopener noreferrer">key/value stores</a>. One particularly insidious class of bugs is related to how one sets keys when writing to these stores. Even slight mistakes in this process can lead to critical vulnerabilities that are usually simple to detect and exploit.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="store-prefix-ending-in-serialized-id">Store Prefix Ending In Serialized ID<a href="#store-prefix-ending-in-serialized-id" class="hash-link" aria-label="Direct link to Store Prefix Ending In Serialized ID" title="Direct link to Store Prefix Ending In Serialized ID">​</a></h3><p>To guarantee uniqueness, it is common to serialize IDs in a store key. However, since these IDs are often in the control of potential attackers (e.g. triggering higher pool IDs by creating more pools), some portion of the keys in these cases can be malleable.</p><p>One way that this frequently surfaces is when developers run a prefix iterator over keys that end in a malleable component (e.g. the pool&#x27;s ID, which an attacker can increase by creating empty pools). In these cases, the iterator might include objects that were not supposed to be in the loop in the first place, meaning that an attacker can trigger unintended behavior. For instance, the prefix iteration on a key that ends with <code>42</code> would also loop over ID <code>421</code>, etc. A more involved example covering a concrete attack vector can be found in the appendix.</p><p><strong>This bug can be resolved in one of two ways:</strong></p><p>a) Add a key separator suffix to the prefix as done <a href="https://github.com/osmosis-labs/osmosis/blob/450f7570a34876b14c61e883f2bf2ea81944f9c7/x/concentrated-liquidity/types/keys.go#L191-L195" target="_blank" rel="noopener noreferrer">here</a>.</p><p>b) Convert malleable numbers in keys to big-endian as done <a href="https://github.com/osmosis-labs/osmosis/blob/450f7570a34876b14c61e883f2bf2ea81944f9c7/x/gamm/types/key.go#L60-L62" target="_blank" rel="noopener noreferrer">here</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-uniqueness">Key Uniqueness<a href="#key-uniqueness" class="hash-link" aria-label="Direct link to Key Uniqueness" title="Direct link to Key Uniqueness">​</a></h3><p>In many instances, it might be tempting to identify a data structure by a collection of their fields. For instance, one might want to key liquidity pools in the following way:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// KeyPool returns the key for the given pool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">KeyPool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pool Pool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s%s%s%s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PoolPrefix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetToken0</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetToken1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetSpreadFactor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, note that there can be multiple pools with the same tokens and spread factor. As a result, an existing entry could be completely overwritten. While the example above is somewhat trivial and would be easily caught by unit tests, more complex instances of this issue come up frequently enough to justify mentioning it. <strong>The solution here is to ensure that keys are unique, usually through the addition of an ID component or some equivalent.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="iterator-bounds">Iterator Bounds<a href="#iterator-bounds" class="hash-link" aria-label="Direct link to Iterator Bounds" title="Direct link to Iterator Bounds">​</a></h3><p>This is another simple example that sometimes catches even the most seasoned Cosmos developers. Prefix iteration is inclusive of the start byte but exclusive of the end byte.</p><p>As a result, iterating forwards requires initializing the iterator with the given start value. See this example from the Osmosis concentrated liquidity module:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// &lt;https://github.com/osmosis-labs/osmosis/blob/b0aee0006ce55d0851773084bd7880db7e32ad70/x/concentrated-liquidity/swapstrategy/one_for_zero.go#L204-L205&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">startKey </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TickIndexToBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentTickIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> prefixStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">startKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On the other hand, iterating in reverse requires adding one more byte to the end byte of the reverse iterator:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// &lt;https://github.com/osmosis-labs/osmosis/blob/b0aee0006ce55d0851773084bd7880db7e32ad70/x/concentrated-liquidity/swapstrategy/zero_for_one.go#L202-L204&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">startKey </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TickIndexToBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentTickIndex </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> prefixStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReverseIterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> startKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Being off by one on such iterators is a frequent cause of critical vulnerabilities that are difficult to catch through testing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fee-market-and-gas-issues">Fee Market and Gas Issues<a href="#fee-market-and-gas-issues" class="hash-link" aria-label="Direct link to Fee Market and Gas Issues" title="Direct link to Fee Market and Gas Issues">​</a></h2><p>For developers on general-purpose chains, fees are usually treated as a black box. Thus, fee-related issues can be particularly unintuitive for those who are not used to thinking about fees as an abstraction. Regardless of whether one is implementing <a href="https://www.faulttolerant.xyz/2023-11-17-fee-credits/" target="_blank" rel="noopener noreferrer">novel fee mechanisms</a> or simply running something out-of-the-box, appchain developers generally have to grapple with risks that arise from having more control over gas.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mispriced-state-writes">Mispriced State Writes<a href="#mispriced-state-writes" class="hash-link" aria-label="Direct link to Mispriced State Writes" title="Direct link to Mispriced State Writes">​</a></h3><p>If a data structure is written to the state during a user-executed message flow, the creation of this data structure must be bounded by a high enough fee to deter spam. If this is not done properly (i.e. either there are insufficient or no fees), then an attacker can DoS the chain similar to how they would be able to through large/unbounded compute in unmetered flows.</p><p>While this might seem trivial in simple cases, there are many scenarios where pricing state writes is nontrivial. This complexity generally surfaces in actions that create externalities for other users.</p><p>For instance, if the protocol includes logic where an arbitrary number of tokens are iterated through linearly, then each new token can potentially push an increasing cost onto the system. In such cases, additional (and scaling) gas <a href="https://github.com/osmosis-labs/osmosis/blob/b0aee0006ce55d0851773084bd7880db7e32ad70/x/tokenfactory/keeper/createdenom.go#L19-L22" target="_blank" rel="noopener noreferrer">must be charged</a> to ensure the protocol is not vulnerable to DoS attacks.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fees-on-contract-called-functions">Fees on Contract-called Functions<a href="#fees-on-contract-called-functions" class="hash-link" aria-label="Direct link to Fees on Contract-called Functions" title="Direct link to Fees on Contract-called Functions">​</a></h3><p>Charging fixed fees distinct from gas is a relatively common design pattern (for instance, Osmosis charges a governance-set fee denominated in OSMO for creating pools). However, introducing such fees often results in risks in scenarios where contracts act on behalf of users. Specifically, this design pattern can cause the fees to be charged incorrectly or, in some cases, even prevent the contract from being used at all.</p><p>In such cases, it often makes sense to simply <a href="https://github.com/osmosis-labs/osmosis/blob/b0aee0006ce55d0851773084bd7880db7e32ad70/x/tokenfactory/keeper/createdenom.go#L95-L98" target="_blank" rel="noopener noreferrer">charge the fee as additional gas</a> so that it gets floated up to the caller. If this is not possible due to the fee being too high, then the fee charge needs to be factored into the design of the contract(s) triggering it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="broken-or-missing-fee-market">Broken or Missing Fee Market<a href="#broken-or-missing-fee-market" class="hash-link" aria-label="Direct link to Broken or Missing Fee Market" title="Direct link to Broken or Missing Fee Market">​</a></h3><p>During periods of high network usage, it is critical to ensure that high-value transactions have a priority for getting on-chain. For example, liquidations can continue to happen to ensure the health of the market as long as a higher fee is provided. To achieve this, there has to be a proxy for demand. <a href="https://www.youtube.com/watch?v=62UI3Js30Io" target="_blank" rel="noopener noreferrer">EIP-1559</a> is a protocol that incorporates a variable base fee that increases or decreases based on historic block sizes. <a href="https://github.com/osmosis-labs/osmosis/blob/b0aee0006ce55d0851773084bd7880db7e32ad70/x/txfees/keeper/mempool-1559" target="_blank" rel="noopener noreferrer">Osmosis recently implemented</a> this directly in the mempool.</p><p>However, the superior long-term solution is to integrate the fee market directly into consensus by leveraging <code>ABCI 2.0</code>. The Skip team has been spearheading <a href="https://github.com/skip-mev/feemarket" target="_blank" rel="noopener noreferrer">the implementation</a> of this initiative which will be released as a pluggable component that chains can integrate.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-simulation-and-execution-gas-consistency">Transaction Simulation and Execution Gas Consistency<a href="#transaction-simulation-and-execution-gas-consistency" class="hash-link" aria-label="Direct link to Transaction Simulation and Execution Gas Consistency" title="Direct link to Transaction Simulation and Execution Gas Consistency">​</a></h3><p>Before submitting a transaction on-chain, clients attempt to simulate its execution to determine how much gas to provide. There is a separate execution mode for simulation that does not commit state but attempts to estimate gas.</p><p>Due to <a href="https://github.com/cosmos/cosmos-sdk/issues/18834" target="_blank" rel="noopener noreferrer">challenges with how Cosmos SDK gas estimation works</a>, the gas estimate often ends up being inconsistent with the actual execution. Many clients get around this today by multiplying their gas estimates by a constant multiplier.</p><p>If the chain increases gas usage in ways that are not included in simulation logic, this could break many clients at chain upgrade time until they increase their gas multipliers.</p><p>The specific area to pay attention to on this front is the <code>simulate</code> parameter in the <code>AnteHandler</code> API. An example that could cause issues might look like the following:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mfd MyMemPoolDecorator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AnteHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tx sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> simulate </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AnteHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newCtx sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">simulate </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Do some gas intensive logic such as many store reads/writes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This will lead to inconsistencies between transaction simulation and execution</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>While this does not affect chain security, it can cause severe client instability until clients update their gas estimation logic. If your appchain supports high-value and time-sensitive transactions such as ones related to collateral and leverage, such issues could be quite problematic.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="closing-remarks">Closing Remarks<a href="#closing-remarks" class="hash-link" aria-label="Direct link to Closing Remarks" title="Direct link to Closing Remarks">​</a></h2><p>Over the past few months, Cosmos has seen an influx of liquidity and users. If we as an ecosystem want to thrive and compete with centralized entities, there has to be a shared focus on security and the desire to share insights on best practices around our stack.</p><p>Our hope with this post was to lay the groundwork from a security standpoint for engineers onboarding onto the Cosmos SDK and appchains more broadly. While this is far from being exhaustive, it is a distillation of years of experience and scar tissue accumulated over many multi-million dollar war rooms.</p><p>As an ecosystem, we cannot afford recklessness or lack of security awareness. <strong>If you have any feedback or contributions you would like to see added to this post (or one of our future posts on CosmWasm and IBC), please reach out to us on Twitter/X @0xalpo and @akhtariev!</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="appendix">Appendix<a href="#appendix" class="hash-link" aria-label="Direct link to Appendix" title="Direct link to Appendix">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="state-machine-scope">State-machine Scope<a href="#state-machine-scope" class="hash-link" aria-label="Direct link to State-machine Scope" title="Direct link to State-machine Scope">​</a></h3><p>The state-machine scope includes the following areas:</p><ul><li>All messages supported by the chain, including:<ul><li>Every msg&#x27;s <code>ValidateBasic</code> method</li><li>Every msg&#x27;s <code>MsgServer</code> method</li><li>Net gas usage, in all execution paths</li><li>Errors (assuming use of Cosmos-SDK errors)</li><li>State changes (namely every store write)</li><li><code>AnteHandler</code>s in <code>execModeFinalize</code></li><li><code>PostHandler</code>s in <code>execModeFinalize</code></li><li>Cosmwasm-whitelisted queries</li></ul></li><li>All BeginBlock/EndBlock logic</li><li>ABCI 2.0 <code>ProcessProposal</code></li><li>ABCI 2.0 <code>VerifyVoteExtensions</code></li></ul><p>The following are NOT in the state-machine scope:</p><ul><li>Events</li><li>Queries that are not Cosmwasm-whitelisted</li><li>CLI interfaces</li><li>Errors (assuming use of Go-native errors)</li><li>ABCI 2.0 <code>PrepareProposal</code></li><li>ABCI 2.0 <code>ExtendVote</code></li><li><code>AnteHandler</code>s in any mode other than <code>execModeFinalize</code></li><li><code>PostHandler</code>s in any mode other than <code>execModeFinalize</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-malleability-and-prefix-iteration-attack-example">Key Malleability and Prefix Iteration Attack Example<a href="#key-malleability-and-prefix-iteration-attack-example" class="hash-link" aria-label="Direct link to Key Malleability and Prefix Iteration Attack Example" title="Direct link to Key Malleability and Prefix Iteration Attack Example">​</a></h3><p>Consider the code below that checks whether the given address is the owner of a given position ID via an<code>IsPositionOwner</code> function. The <code>KeyAddressPoolIdPositionId</code> formats the key ending with a pool ID as a string. <code>HasAnyAtPrefix</code> function checks if there exists an entry at a given prefix.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// KeyAddressPoolIdPositionId returns the full key needed to store the position id for given addr + pool id + position id combination.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">KeyAddressPoolIdPositionId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> poolId </span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> positionId </span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s%s%x%s%d%s%d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PositionPrefix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> KeySeparator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> KeySeparator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> poolId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> KeySeparator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> positionId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>IsPositionOwner(address sdk.AccAddress, positionID uint64) bool</code> function checks if there exists an entry in the key-value store with the given prefix formatted per <code>KeyAddressPoolIdPositionId</code> structure.</p><p>To achieve that, it might be tempting to use a store helper such as <code>HasAnyAtPrefix</code>. Unfortunately, this would be fatal.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// HasAnyAtPrefix returns true if there is at least one value in the given prefix.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> HasAnyAtPrefix</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T any</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storeObj store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">KVStore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prefix </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parseValue </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetFirstValueInRange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storeObj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PrefixEndBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prefix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parseValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ErrNoValuesInRange </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// GetFirstValueInRange returns the first value between [keyStart, keyEnd)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> GetFirstValueInRange</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T any</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storeObj store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">KVStore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyStart </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyEnd </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reverseIterate </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parseValue </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iterator </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeIterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storeObj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyStart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyEnd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reverseIterate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> iterator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Valid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> blankValue T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blankValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ErrNoValuesInRange</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parseValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To fully grasp the root of the issue, consider the following snapshot:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// &lt;https://go.dev/play/p/Uzl3cqYPtG1&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">poolId </span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    formattedString </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> poolId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byteSlice </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">formattedString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Original String: %s\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> formattedString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Byte Slice: %v\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> byteSlice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    poolIDOne </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    poolIDTwo </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">421</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Prints:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Original String: 42</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Byte Slice: [52 50]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">poolIDOne</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Prints:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Original String: 421</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Byte Slice: [52 50 49]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">poolIDTwo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Both <code>poolIDOne</code> and <code>poolIDTwo</code> have the same prefix.</p><p>Now, our original position existence check with <code>HasAnyAtPrefix</code> would pass if it was run on <code>poolID</code> of <code>42</code> when the user only owned a position ID <code>421</code>. This can result in malicious users getting access to positions that they do not own.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/v0.52/build/building-apps/system-tests"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">System Tests</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/v0.52/build/building-modules/intro"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Introduction to Cosmos SDK Modules</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#non-determinism" class="table-of-contents__link toc-highlight">Non-Determinism</a><ul><li><a href="#randomness" class="table-of-contents__link toc-highlight">Randomness</a></li><li><a href="#go-map-internals" class="table-of-contents__link toc-highlight">Go map internals</a></li><li><a href="#invalid-time-handling" class="table-of-contents__link toc-highlight">Invalid Time Handling</a></li><li><a href="#api-calls" class="table-of-contents__link toc-highlight">API calls</a></li><li><a href="#concurrency-and-multithreading" class="table-of-contents__link toc-highlight">Concurrency And Multithreading</a></li><li><a href="#cross-platform-floats" class="table-of-contents__link toc-highlight">Cross-Platform Floats</a></li></ul></li><li><a href="#in-protocol-panics" class="table-of-contents__link toc-highlight">In-Protocol Panics</a><ul><li><a href="#math-overflow" class="table-of-contents__link toc-highlight">Math Overflow</a></li><li><a href="#bulk-coin-sends" class="table-of-contents__link toc-highlight">Bulk Coin Sends</a></li></ul></li><li><a href="#unmetered-computation" class="table-of-contents__link toc-highlight">Unmetered Computation</a><ul><li><a href="#unmetered-execution-in-hooks" class="table-of-contents__link toc-highlight">Unmetered Execution in Hooks</a></li><li><a href="#poorly-chosen-looprecursion-exit-condition" class="table-of-contents__link toc-highlight">Poorly Chosen Loop/Recursion Exit Condition</a></li><li><a href="#slow-convergence-in-math-operations" class="table-of-contents__link toc-highlight">Slow Convergence in Math Operations</a></li></ul></li><li><a href="#key-malleability-and-prefix-iteration" class="table-of-contents__link toc-highlight">Key Malleability and Prefix Iteration</a><ul><li><a href="#store-prefix-ending-in-serialized-id" class="table-of-contents__link toc-highlight">Store Prefix Ending In Serialized ID</a></li><li><a href="#key-uniqueness" class="table-of-contents__link toc-highlight">Key Uniqueness</a></li><li><a href="#iterator-bounds" class="table-of-contents__link toc-highlight">Iterator Bounds</a></li></ul></li><li><a href="#fee-market-and-gas-issues" class="table-of-contents__link toc-highlight">Fee Market and Gas Issues</a><ul><li><a href="#mispriced-state-writes" class="table-of-contents__link toc-highlight">Mispriced State Writes</a></li><li><a href="#fees-on-contract-called-functions" class="table-of-contents__link toc-highlight">Fees on Contract-called Functions</a></li><li><a href="#broken-or-missing-fee-market" class="table-of-contents__link toc-highlight">Broken or Missing Fee Market</a></li><li><a href="#transaction-simulation-and-execution-gas-consistency" class="table-of-contents__link toc-highlight">Transaction Simulation and Execution Gas Consistency</a></li></ul></li><li><a href="#closing-remarks" class="table-of-contents__link toc-highlight">Closing Remarks</a></li><li><a href="#appendix" class="table-of-contents__link toc-highlight">Appendix</a><ul><li><a href="#state-machine-scope" class="table-of-contents__link toc-highlight">State-machine Scope</a></li><li><a href="#key-malleability-and-prefix-iteration-attack-example" class="table-of-contents__link toc-highlight">Key Malleability and Prefix Iteration Attack Example</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cosmos.network"><img src="/img/logo-bw.svg" alt="Cosmos Logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hub.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.cometbft.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">CometBFT<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ibc.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC Go<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/api">REST API</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/interchain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://reddit.com/r/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/interchain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/cosmos_sdk" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/CosmosProject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cosmosproject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p>The development of the Cosmos SDK is led primarily by <a href="https://interchain.io/ecosystem">Interchain Core Teams</a>. Funding for this development comes primarily from the Interchain Foundation, a Swiss non-profit.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.ae6eca12.js"></script>
<script src="/assets/js/main.5e40e4cd.js"></script>
</body>
</html>