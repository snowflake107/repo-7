"use strict";(self.webpackChunkcosmos_sdk_docs=self.webpackChunkcosmos_sdk_docs||[]).push([[46238],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>h});var i=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,i,r=function(e,t){if(null==e)return{};var a,i,r={},n=Object.keys(e);for(i=0;i<n.length;i++)a=n[i],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(i=0;i<n.length;i++)a=n[i],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=i.createContext({}),p=function(e){var t=i.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=p(e.components);return i.createElement(s.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var a=e.components,r=e.mdxType,n=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(a),m=r,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||n;return a?i.createElement(h,o(o({ref:t},c),{},{components:a})):i.createElement(h,o({ref:t},c))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var n=a.length,o=new Array(n);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<n;p++)o[p]=a[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,a)}m.displayName="MDXCreateElement"},97967:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>n,metadata:()=>l,toc:()=>p});var i=a(87462),r=(a(67294),a(3905));const n={},o="ADR 071: Cryptography v2- Multi-curve support",l={unversionedId:"build/architecture/adr-071-crypto-v2-multi-curve",id:"build/architecture/adr-071-crypto-v2-multi-curve",title:"ADR 071: Cryptography v2- Multi-curve support",description:"Change log",source:"@site/docs/build/architecture/adr-071-crypto-v2-multi-curve.md",sourceDirName:"build/architecture",slug:"/build/architecture/adr-071-crypto-v2-multi-curve",permalink:"/main/build/architecture/adr-071-crypto-v2-multi-curve",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"buildSidebar",previous:{title:"ADR-71 Bank V2",permalink:"/main/build/architecture/adr-071-bank-v2"},next:{title:"ADR 073: Built-in In-process Indexer",permalink:"/main/build/architecture/adr-073-indexer"}},s={},p=[{value:"Change log",id:"change-log",level:2},{value:"Status",id:"status",level:2},{value:"Abstract",id:"abstract",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Glossary",id:"glossary",level:3},{value:"Context",id:"context",level:2},{value:"Objectives",id:"objectives",level:2},{value:"Technical Goals",id:"technical-goals",level:2},{value:"Proposed architecture",id:"proposed-architecture",level:2},{value:"Components",id:"components",level:3},{value:"Storage and persistence",id:"storage-and-persistence",level:4},{value:"Protobuf message structure",id:"protobuf-message-structure",level:5},{value:"Creating and loading a <code>CryptoProvider</code>",id:"creating-and-loading-a-cryptoprovider",level:5},{value:"Keyring",id:"keyring",level:5},{value:"Especial use case: remote signers",id:"especial-use-case-remote-signers",level:5},{value:"Alternatives",id:"alternatives",level:2},{value:"Decision",id:"decision",level:2},{value:"Consequences",id:"consequences",level:2},{value:"Impact on the SDK codebase",id:"impact-on-the-sdk-codebase",level:3},{value:"Client",id:"client",level:4},{value:"State Machine",id:"state-machine",level:4},{value:"Backwards Compatibility",id:"backwards-compatibility",level:3},{value:"Positive",id:"positive",level:3},{value:"Negative",id:"negative",level:3},{value:"Neutral",id:"neutral",level:3},{value:"Test Cases",id:"test-cases",level:2}],c={toc:p},d="wrapper";function u(e){let{components:t,...a}=e;return(0,r.kt)(d,(0,i.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"adr-071-cryptography-v2--multi-curve-support"},"ADR 071: Cryptography v2- Multi-curve support"),(0,r.kt)("h2",{id:"change-log"},"Change log"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"May 7th 2024: Initial Draft (Zondax AG: @raynaudoe @juliantoledano @jleni @educlerici-zondax @lucaslopezf)"),(0,r.kt)("li",{parentName:"ul"},"June 13th 2024: Add CometBFT implementation proposal (Zondax AG: @raynaudoe @juliantoledano @jleni @educlerici-zondax @lucaslopezf)"),(0,r.kt)("li",{parentName:"ul"},"July 2nd 2024: Split ADR proposal, add link to ADR in cosmos/crypto (Zondax AG: @raynaudoe @juliantoledano @jleni @educlerici-zondax @lucaslopezf)")),(0,r.kt)("h2",{id:"status"},"Status"),(0,r.kt)("p",null,"DRAFT"),(0,r.kt)("h2",{id:"abstract"},"Abstract"),(0,r.kt)("p",null,"This ADR proposes the refactoring of the existing ",(0,r.kt)("inlineCode",{parentName:"p"},"Keyring")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"cosmos-sdk/crypto")," code to implement ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cosmos/crypto/blob/main/docs/architecture/adr-001-crypto-provider.md"},"ADR-001-CryptoProviders"),"."),(0,r.kt)("p",null,"For in-depth details of the ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProviders")," and their design please refer to ADR mentioned above."),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"The introduction of multi-curve support in the cosmos-sdk cryptographic package offers significant advantages. By not being restricted to a single cryptographic curve, developers can choose the most appropriate curve based on security, performance, and compatibility requirements. This flexibility enhances the application's ability to adapt to evolving security standards and optimizes performance for specific use cases, helping to future-proofing the sdk's cryptographic capabilities."),(0,r.kt)("p",null,"The enhancements in this proposal not only render the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cosmos/cosmos-sdk/issues/14940"},'"Keyring ADR"')," obsolete, but also encompass its key aspects, replacing it with a more flexible and comprehensive approach. Furthermore, the gRPC service proposed in the mentioned ADR can be easily implemented as a specialized ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider"),". "),(0,r.kt)("h3",{id:"glossary"},"Glossary"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Interface"),': In the context of this document, "interface" refers to Go\'s interface.')),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Module"),': In this document, "module" refers to a Go module.')),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Package"),': In the context of Go, a "package" refers to a unit of code organization.'))),(0,r.kt)("h2",{id:"context"},"Context"),(0,r.kt)("p",null,"In order to fully understand the need for changes and the proposed improvements, it's crucial to consider the current state of affairs:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The Cosmos SDK currently lacks a comprehensive ADR for the cryptographic package.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"If a blockchain project requires a cryptographic curve that is not supported by the current SDK, the most likely scenario is that they will need to fork the SDK repository and make modifications. These modifications could potentially make the fork incompatible with future updates from the upstream SDK, complicating maintenance and integration.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Type leakage of specific crypto data types expose backward compatibility and extensibility challenges.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The demand for a more flexible and extensible approach to cryptography and address management is high.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Architectural changes are necessary to resolve many of the currently open issues related to new curves support.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"There is a current trend towards modularity in the Interchain stack (e.g., runtime modules).")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Security implications are a critical consideration during the redesign work."))),(0,r.kt)("h2",{id:"objectives"},"Objectives"),(0,r.kt)("p",null,"The key objectives for this proposal are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Leverage ",(0,r.kt)("inlineCode",{parentName:"li"},"CryptoProviders"),": Utilize them as APIs for cryptographic tools, ensuring modularity, flexibility, and ease of integration.")),(0,r.kt)("p",null,"Developer-Centric Approach"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Prioritize clear, intuitive interfaces and best-practice design principles.")),(0,r.kt)("p",null,"Quality Assurance"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Enhanced Test Coverage: Improve testing methodologies to ensure the robustness and reliability of the module.")),(0,r.kt)("h2",{id:"technical-goals"},"Technical Goals"),(0,r.kt)("p",null,"New Keyring:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Design a new ",(0,r.kt)("inlineCode",{parentName:"li"},"Keyring")," interface with modular backends injection system to support hardware devices and cloud-based HSMs. This feature is optional and tied to complexity; if it proves too complex, it will be deferred to a future release as an enhancement.")),(0,r.kt)("h2",{id:"proposed-architecture"},"Proposed architecture"),(0,r.kt)("h3",{id:"components"},"Components"),(0,r.kt)("p",null,"The main components to be used will be the same as those found in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cosmos/crypto/blob/main/docs/architecture/adr-001-crypto-provider.md#components"},"ADR-001"),"."),(0,r.kt)("h4",{id:"storage-and-persistence"},"Storage and persistence"),(0,r.kt)("p",null,"The storage and persistence layer is tasked with storing a ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider"),"s. Specifically, this layer must:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Securely store the crypto provider's associated private key (only if stored locally, otherwise a reference to the private key will be stored instead)."),(0,r.kt)("li",{parentName:"ul"},"Store the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/cosmos/crypto/blob/main/docs/architecture/adr-001-crypto-provider.md#metadata"},(0,r.kt)("inlineCode",{parentName:"a"},"ProviderMetadata"))," struct which contains the data that distinguishes that provider.")),(0,r.kt)("p",null,"The purpose of this layer is to ensure that upon retrieval of the persisted data, we can access the provider's type, version, and specific configuration (which varies based on the provider type). This information will subsequently be utilized to initialize the appropriate factory, as detailed in the following section on the factory pattern."),(0,r.kt)("p",null,"The storage proposal involves using a modified version of the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cosmos/cosmos-sdk/blob/main/proto/cosmos/crypto/keyring/v1/record.proto"},"Record")," struct, which is already defined in ",(0,r.kt)("strong",{parentName:"p"},"Keyring/v1"),". Additionally, we propose utilizing the existing keyring backends (keychain, filesystem, memory, etc.) to store these ",(0,r.kt)("inlineCode",{parentName:"p"},"Record"),"s in the same manner as the current ",(0,r.kt)("strong",{parentName:"p"},"Keyring/v1"),"."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note: This approach will facilitate a smoother migration path from the current Keyring/v1 to the proposed architecture.")),(0,r.kt)("p",null,"Below is the proposed protobuf message to be included in the modified ",(0,r.kt)("inlineCode",{parentName:"p"},"Record.proto")," file"),(0,r.kt)("h5",{id:"protobuf-message-structure"},"Protobuf message structure"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cosmos/cosmos-sdk/blob/main/proto/cosmos/crypto/keyring/v1/record.proto"},"record.proto")," file will be modified to include the ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider")," message as an optional field as follows."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-protobuf"},"\n// record.proto\n\nmessage Record {\n  string name = 1;\n  google.protobuf.Any pub_key = 2;\n\n  oneof item {\n    Local local = 3;\n    Ledger ledger = 4;\n    Multi multi = 5;\n    Offline offline = 6;\n    CryptoProvider crypto_provider = 7; // <- New\n  }\n\n  message Local {\n    google.protobuf.Any priv_key = 1;\n  }\n\n  message Ledger {\n    hd.v1.BIP44Params path = 1;\n  }\n\n  message Multi {}\n\n  message Offline {}\n}\n")),(0,r.kt)("h5",{id:"creating-and-loading-a-cryptoprovider"},"Creating and loading a ",(0,r.kt)("inlineCode",{parentName:"h5"},"CryptoProvider")),(0,r.kt)("p",null,"For creating providers, we propose a ",(0,r.kt)("em",{parentName:"p"},"factory pattern")," and a ",(0,r.kt)("em",{parentName:"p"},"registry")," for these builders. Examples of these\npatterns can be found ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cosmos/crypto/blob/main/docs/architecture/adr-001-crypto-provider.md#illustrative-code-snippets"},"here")),(0,r.kt)("h5",{id:"keyring"},"Keyring"),(0,r.kt)("p",null,"The new ",(0,r.kt)("inlineCode",{parentName:"p"},"Keyring")," interface will serve as a central hub for managing and fetching ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProviders"),". To ensure a smoother migration path, the new Keyring will be backward compatible with the previous version. Since this will be the main API from which applications will obtain their ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider")," instances, the proposal is to extend the Keyring interface to include the methods:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type KeyringV2 interface {\n  // methods from Keyring/v1\n  \n  // ListCryptoProviders returns a list of all the stored CryptoProvider metadata.\n  ListCryptoProviders() ([]ProviderMetadata, error)\n  \n  // GetCryptoProvider retrieves a specific CryptoProvider by its id.\n  GetCryptoProvider(id string) (CryptoProvider, error)\n}\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note"),": Methods to obtain a provider from a public key or other means that make it easier to load the desired provider can be added."),(0,r.kt)("h5",{id:"especial-use-case-remote-signers"},"Especial use case: remote signers"),(0,r.kt)("p",null,"It's important to note that the ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider")," interface is versatile enough to be implemented as a remote signer. This capability allows for the integration of remote cryptographic operations, which can be particularly useful in distributed or cloud-based environments where local cryptographic resources are limited or need to be managed centrally."),(0,r.kt)("h2",{id:"alternatives"},"Alternatives"),(0,r.kt)("p",null,"It is important to note that all the code presented in this document is not in its final form and could be subject to changes at the time of implementation. The examples and implementations discussed should be interpreted as alternatives, providing a conceptual framework rather than definitive solutions. This flexibility allows for adjustments based on further insights, technical evaluations, or changing requirements as development progresses."),(0,r.kt)("h2",{id:"decision"},"Decision"),(0,r.kt)("p",null,"We will:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Leverage crypto providers"),(0,r.kt)("li",{parentName:"ul"},"Refactor the module structure as described above."),(0,r.kt)("li",{parentName:"ul"},"Define types and interfaces as the code attached."),(0,r.kt)("li",{parentName:"ul"},"Refactor existing code into new structure and interfaces."),(0,r.kt)("li",{parentName:"ul"},"Implement Unit Tests to ensure no backward compatibility issues.")),(0,r.kt)("h2",{id:"consequences"},"Consequences"),(0,r.kt)("h3",{id:"impact-on-the-sdk-codebase"},"Impact on the SDK codebase"),(0,r.kt)("p",null,"We can divide the impact of this ADR into two main categories: state machine code and client related code."),(0,r.kt)("h4",{id:"client"},"Client"),(0,r.kt)("p",null,"The major impact will be on the client side, where the current ",(0,r.kt)("inlineCode",{parentName:"p"},"Keyring")," interface will be replaced by the new ",(0,r.kt)("inlineCode",{parentName:"p"},"KeyringV2")," interface. At first, the impact will be low since ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider")," is an optional field in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Record")," message, so there's no mandatory requirement for migrating to this new concept right away. This allows a progressive transition where the risks of breaking changes or regressions are minimized."),(0,r.kt)("h4",{id:"state-machine"},"State Machine"),(0,r.kt)("p",null,"The impact on the state machine code will be minimal, the modules affected (at the time of writing this ADR)\nare the ",(0,r.kt)("inlineCode",{parentName:"p"},"x/accounts")," module, specifically the ",(0,r.kt)("inlineCode",{parentName:"p"},"Authenticate")," function and the ",(0,r.kt)("inlineCode",{parentName:"p"},"x/auth/ante")," module. This function will need to be adapted to use a ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider")," service to make use of the ",(0,r.kt)("inlineCode",{parentName:"p"},"Verifier")," instance."),(0,r.kt)("p",null,"Worth mentioning that there's also the alternative of using ",(0,r.kt)("inlineCode",{parentName:"p"},"Verifier")," instances in a standalone fashion (see note below)."),(0,r.kt)("p",null,"The specific way to adapt these modules will be deeply analyzed and decided at implementation time of this ADR."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note"),": All cryptographic tools (hashers, verifiers, signers, etc.) will continue to be available as standalone packages that can be imported and utilized directly without the need for a ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider")," instance. However, the ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider")," is the recommended method for using these tools as it offers a more secure way to handle sensitive data, enhanced modularity, and the ability to store configurations and metadata within the ",(0,r.kt)("inlineCode",{parentName:"p"},"CryptoProvider")," definition."),(0,r.kt)("h3",{id:"backwards-compatibility"},"Backwards Compatibility"),(0,r.kt)("p",null,"The proposed migration path is similar to what the cosmos-sdk has done in the past. To ensure a smooth transition, the following steps will be taken:"),(0,r.kt)("p",null,"Once ADR-001 is implemented with a stable release:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Deprecate the old crypto package. The old crypto package will still be usable, but it will be marked as deprecated and users can opt to use the new package."),(0,r.kt)("li",{parentName:"ul"},"Migrate the codebase to use the new cosmos/crypto package and remove the old crypto one.")),(0,r.kt)("h3",{id:"positive"},"Positive"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Single place of truth"),(0,r.kt)("li",{parentName:"ul"},"Easier to use interfaces"),(0,r.kt)("li",{parentName:"ul"},"Easier to extend"),(0,r.kt)("li",{parentName:"ul"},"Unit test for each crypto package"),(0,r.kt)("li",{parentName:"ul"},"Greater maintainability"),(0,r.kt)("li",{parentName:"ul"},"Incentivize addition of implementations instead of forks"),(0,r.kt)("li",{parentName:"ul"},"Decoupling behavior from implementation"),(0,r.kt)("li",{parentName:"ul"},"Sanitization of code")),(0,r.kt)("h3",{id:"negative"},"Negative"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"It will involve an effort to adapt existing code."),(0,r.kt)("li",{parentName:"ul"},"It will require attention to detail and audition.")),(0,r.kt)("h3",{id:"neutral"},"Neutral"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"It will involve extensive testing.")),(0,r.kt)("h2",{id:"test-cases"},"Test Cases"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The code will be unit tested to ensure a high code coverage"),(0,r.kt)("li",{parentName:"ul"},"There should be integration tests around Keyring and CryptoProviders.")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"While an ADR is in the DRAFT or PROPOSED stage, this section should contain a\nsummary of issues to be solved in future iterations (usually referencing comments\nfrom a pull-request discussion)."),(0,r.kt)("p",{parentName:"blockquote"},"Later, this section can optionally list ideas or improvements the author or\nreviewers found during the analysis of this ADR.")))}u.isMDXComponent=!0}}]);